import{c as dt,d as V,B as C,g as ut,e as Y,p as Z,b as ht}from"./empty-3bc3eff6.js";import{_ as tt,o as l,e as h,q as _,j as A,p as f,A as ft,bM as st,bN as pt,t as yt,W as Q,s as u,J as gt,F as j,h as it,k as O,bO as q,bP as E,bQ as mt,bR as B,a as T,x as R,C as rt,y as wt,B as _t,bS as St,r as I,b as bt,c as G,w as P,d as At,f as U}from"./index-b9487ae2.js";import{a as F,c as vt,s as D,f as M,d as at,h as ot,i as N,r as It,e as k,j as xt}from"./price-a34b76bc.js";import{a as J,d as X,b as Ct}from"./db-43d10708.js";import{W as et,O as ct}from"./Wif-86a6c756.js";const Bt={props:["url"],data(){return{fileType:"",data:""}},mounted(){this.init()},watch:{url(){this.init()}},methods:{async init(){if(!this.url){this.data="",this.fileType="";return}const{pathname:t}=new URL(this.url),i=t.slice(t.lastIndexOf("/")+1);if(["mp4","webm","ogg"].includes(i.split(".").pop()?.toLowerCase()))this.fileType="VIDIO",this.data=this.url;else if(["jpg","jpeg","webp","gif","png","bmp"].includes(i.split(".").pop()?.toLowerCase()))this.fileType="IMAGE",this.data=this.url;else{this.fileType="TEXT";const a=await fetch(this.url).then(o=>o.text());this.data=a}}}},Tt={style:{height:"300px","text-align":"center"}},Pt={key:0},Ut={key:1,style:{"max-height":"300px","max-width":"100%"},id:"mainPlayer",autoplay:"",controls:""},kt=["src"],Nt=["src"],Dt={key:3,style:{"max-height":"300px","max-width":"100%"}};function Ht(t,i,a,o,e,n){return l(),h("div",Tt,[e.fileType?_("",!0):(l(),h("div",Pt,"loading")),e.fileType==="VIDIO"?(l(),h("video",Ut,[A("source",{src:e.data},null,8,kt)])):_("",!0),e.fileType==="IMAGE"?(l(),h("img",{key:2,style:{"max-height":"300px","max-width":"100%"},src:e.data},null,8,Nt)):_("",!0),e.fileType==="TEXT"?(l(),h("div",Dt,f(e.data),1)):_("",!0)])}const Ot=tt(Bt,[["render",Ht]]);function H(t,i){const a=dt.clone();a.config({EXPONENTIAL_AT:[-30,30]});let o="",e="";const n=t.toString().split(".");return n[1]?(e=new a(`0.${n[1]}`).sd(i,a.ROUND_HALF_UP).toString(),e==="1"?o+=new a(`${n[0]}`).plus(new a(`${e}`)).toFixed():o+=`${n[0]}.${e.split("0.")[1]}`,o):t.toString()}function W(t){return C(t).div(Q.toString()).toString()}async function Ft(t,i,a,o){const e=await F(t,i,!1),n=await e.getSeriesInfo(o),{_holdingScoreCoefficients:s,_holdingTokens:r,_paymentScoreCoefficients:c,_paymentTokens:d}=await e.getScoreCoefficients(),p=["function symbol() view returns (string)","function balanceOf(address account) external view returns (uint256)","function decimals() view returns (uint8)"],y=await Promise.all(r.map(b=>b===ft?{balanceOf(S){return st().getBalance(S)},symbol(){return i===1e4?"BCH":"BNB"},decimals(){return 18}}:pt(b,p,i,!1))),w=await Promise.all(y.map(b=>b.symbol())),g=await Promise.all(y.map(b=>b.balanceOf(a))),m=await Promise.all(y.map(b=>b.decimals())),v=await e.getSeriesScore(a,o),L=v.gte(n.requiredScore),z=r.map((b,S)=>({token:r[S],symbol:w[S],userScoreCoefficient:H(W(g[S].mul(s[S]).div(V("1",m[S])).toString()),2),userBalance:H(C(g[S].toString()).div(V("1",m[S]).toString()).toString(),2),needAmount:L?0:H(W(n.requiredScore.sub(v).mul(V("1",18)).div(s[S]).toString()),2)})),$=await vt(i);return{tokens:z,seriesInfo:{description:yt(n.description),requiredScore:W(n.requiredScore.toString())},totalScore:H(W(v.toString()),2),usdPrice:$}}async function K(t,i,a,o){const e=await F(t,i,!1);let n=await e.getSeriesScore(a,o);const s=await e.getSeriesInfo(o);return n.gte(s.requiredScore)}const Et={props:["file"],data(){return{scoresInfo:null,filePrice:null,enoughScore:null,store:u}},methods:{async init(){if(!this.file){this.scoresInfo=null,this.filePrice=0,this.enoughScore=null;return}const{seriesId:t}=D(this.file.fileid);this.scoresInfo=await Ft(this.file.decryptionguides[0].contract,this.file.decryptionguides[0].chainid,u.account,t),this.enoughScore=await K(this.file.decryptionguides[0].contract,this.file.decryptionguides[0].chainid,u.account,t),this.filePrice=ut(await M(this.file.decryptionguides[0].contract,this.file.decryptionguides[0].chainid,this.file.fileid))},toPrecision_(t){return H(t,2)},getNativeCurrencySymbol(){const{nativeCurrencySymbol:t}=gt(this.file.decryptionguides[0].chainid);return t}},watch:{file(){this.init()},"store.account"(){this.scoresInfo=null,this.filePrice=null,this.enoughScore=null,this.init()}}},Rt={key:0,style:{margin:"20px"}},Wt={style:{"margin-top":"20px"}},Mt={style:{"margin-top":"20px"}},Lt=A("br",null,null,-1),zt={style:{"margin-top":"20px"}},$t={key:0},Vt={key:0,style:{"margin-top":"20px"}},jt={key:1};function qt(t,i,a,o,e,n){return l(),h(j,null,[e.scoresInfo?(l(),h("div",Rt,[A("div",Wt,' This file is in the series "'+f(e.scoresInfo.seriesInfo.description)+'" and requires '+f(e.scoresInfo.seriesInfo.requiredScore)+" score to play. ",1),A("div",Mt,[(l(!0),h(j,null,it(e.scoresInfo.tokens,(s,r)=>(l(),h("span",null,[O("You own "+f(s.userBalance)+" "+f(s.symbol)+" and get "+f(s.userScoreCoefficient)+" scores.",1),Lt]))),256))]),A("div",zt,[O(" You get "+f(e.scoresInfo.totalScore)+" scores in total, which are "+f(e.enoughScore?"enough":"not enough")+" to view the files in this series for free. ",1),e.enoughScore?_("",!0):(l(),h("div",$t,[O(" You need get "),(l(!0),h(j,null,it(e.scoresInfo.tokens,(s,r)=>(l(),h("span",null,f(r!==0&&" or"||"")+" "+f(s.needAmount)+" "+f(s.symbol),1))),256))]))]),e.filePrice!=="0"?(l(),h("div",Vt," To view this file, you need pay "+f(e.filePrice)+" "+f(n.getNativeCurrencySymbol())+"("+f(n.toPrecision_(e.filePrice*e.scoresInfo.usdPrice))+" usd) ",1)):_("",!0)])):_("",!0),e.scoresInfo?_("",!0):(l(),h("div",jt," loading "))],64)}const Gt=tt(Et,[["render",qt]]);async function Jt(t,i,a,o,e,n){window.WifAndAddr||await window.GetWIF(t);const s=await et.fromWIF(window.WifAndAddr[0]),r=window.WifAndAddr[1],c=bchaddr.toCashAddress(i),d=t.utils.arrayify(a),p=t.utils.arrayify(o),y=t.utils.arrayify(r),w=t.utils.arrayify(e),g=lt([Uint8Array.of(106),Uint8Array.of(4,69,71,84,88),Uint8Array.of(p.length),p,Uint8Array.of(y.length),y,Uint8Array.of(d.length),d,Uint8Array.of(w.length),w]);console.log("opReturnU8A:",g);const m=ct.fromBuffer(g);return console.log("opRet:",m),await s.send([m,{cashaddr:c,value:n,unit:"sat"}])}async function Xt(t,i,a,o,e,n){window.WifAndAddr||await window.GetWIF(t);const s=await et.fromWIF(window.WifAndAddr[0]),r=window.WifAndAddr[1],c=bchaddr.toCashAddress(i),d=t.utils.arrayify(a),p=t.utils.arrayify(o),y=t.utils.arrayify(r),w=t.utils.arrayify(e),g=lt([Uint8Array.of(106),Uint8Array.of(4,69,71,84,88),Uint8Array.of(p.length),p,Uint8Array.of(y.length),y,Uint8Array.of(d.length),d,Uint8Array.of(w.length),w,Uint8Array.of(0),Uint8Array.of(2,12,205)]);console.log("opReturnU8A:",g);const m=ct.fromBuffer(g);return console.log("opRet:",m),(await s.encodeTransaction([m,{cashaddr:c,value:n,unit:"sat"}])).encodedTransaction}function lt(t){let i=t.reduce((e,n)=>e+n.length,0);console.log(i);let a=new Uint8Array(i);if(!t.length)return a;let o=0;for(let e of t)a.set(e,o),o+=e.length;return a}async function nt(){window.WifAndAddr||await window.GetWIF(Y);let i=await(await et.fromWIF(window.WifAndAddr[0])).getBalance();return i=Z(i.bch.toString()),i.toString()}const x=await k.Sesstion.startSession(rt.coordinatorUrl),Yt={components:{Media:Ot,Scores:Gt},data(){return{url:"",file:null,readme:null,homepage:"",payType:0,store:u}},async mounted(){try{await this.init(),await this.check()}catch(t){console.log(t)}},watch:{"store.account"(){window.WifAndAddr="",this.file&&(this.url="",this.payType=0,this.homepage="",this.check())}},methods:{async payByStochastic(){try{const t=q({duration:0,forbidClick:!0,message:"paying"}),{author:i}=this.readme,a=this.file.fileid,o=C(await M(this.file.decryptionguides[0].contract,this.file.decryptionguides[0].chainid,this.file.fileid)).multipliedBy(1e8).div(Q.toString()).integerValue(C.ROUND_CEIL).multipliedBy(20).toFixed(0);if(E.from(await nt()).lt(E.from(o).add(Z("0.0001"))))throw new Error("not enough balance");const s=await(await F(this.file.decryptionguides[0].contract,this.file.decryptionguides[0].chainid,!1)).bchPayee(),r=at(s);let c=await Xt(Y,r,i,"0x56eb561cb6f98a985f80464fa99267a462c91bdb",a,o);c=mt.from(c).toString("hex");const d=await x.coordinator.getProxy("bchrelayer"),p=await fetch(`${d}/judge?tx=${c}`).then(S=>S.json());if(t.message="pay success",!p.success)throw new Error(p);const{logSig:y,rawLog:{topics:w,data:g,timestamp:m},vrfAlpha:v,prob16:L,rand16:z}=p.result,$=await ot(w,g,y,{ts:parseInt(m)}),b=N(a,3,$);await J(u.account,this.file.decryptionguides[0].chainid,this.$route.params.cid,"STOCHASTIC",i,C(o).multipliedBy(1e10).toString(),parseInt(m)*1e3,z<L?v:"",this.readme.introduction,b),await this.downloadBySTOCHASTIC(),B()}catch(t){B(),T(t.message)}},async init(){try{const t=this.$route.params.cid;this.readme=JSON.parse(await x.getReadme(t));const a=(await x.getConfig(t)).files[0];this.file=a;const o=await F(this.file.decryptionguides[0].contract,this.file.decryptionguides[0].chainid,!1);this.homepage=ht(await o.homepage())}catch(t){T(t.message)}},nav(){this.$router.push({name:"index"})},async downloadByMainChain(){const t=this.file.fileid,{author:i}=this.readme,a=new Headers;a.append("Content-Type","application/json");const o=JSON.stringify({jsonrpc:"2.0",method:"eth_getLogs",params:[{address:"0x56eb561cb6f98a985f80464fa99267a462c91bdb",fromBlock:"0x0",topics:[R(u.account,32),R(i,32),t]}],id:1}),e={method:"POST",headers:a,body:o},s=(await It(rt.MAIN_CHAIN_RPCURL,e,10).then(m=>m.json())).result.pop().blockHash,r=[R(u.account,32),R(i,32),t],c=await x.coordinator.getProxy("bch"),d=await new k.Authorizer(c).getLog("0x56eb561cb6f98a985f80464fa99267a462c91bdb",s,r,10),p=`0x${k.base64ToHex(d.proof)}`,y=`0x${k.base64ToHex(d.result).slice(-640)}`,w=await ot(r,y,p),g=N(t,2,w);await this.download(g)},async pay(){try{const t=E.from(D(this.file.fileid).priceInWei).add(Z("0.0001"));if(u.chainId===1e4&&E.from(await nt()).gte(t)){await this.payByMainChain();return}if((await(await st()).getBalance(u.account)).gte(t)){await this.payBySmartChain();return}throw new Error("Insufficient balance")}catch(t){console.error(t),T(t.message)}},async payByMainChain(){try{const t=q({duration:0,forbidClick:!0,message:"paying"}),{author:i}=this.readme,o=await(await F(this.file.decryptionguides[0].contract,this.file.decryptionguides[0].chainid,!1)).bchPayee(),e=at(o),n=this.file.fileid,s=await M(this.file.decryptionguides[0].contract,this.file.decryptionguides[0].chainid,this.file.fileid),r=C(s).multipliedBy(1e8).div(Q.toString()).integerValue(C.ROUND_CEIL).toFixed(0),c=await Jt(Y,e,i,"0x56eb561cb6f98a985f80464fa99267a462c91bdb",n,r);await J(u.account,this.file.decryptionguides[0].chainid,this.$route.params.cid,"MAIN_CHAIN",i,s,new Date().getTime(),c.txId,this.readme.introduction),t.message="pay success",await new Promise((d,p)=>setTimeout(()=>{d(0)},1e3)),t.message="downloading",await this.downloadByMainChain(),B()}catch(t){B(),T(t.message)}},async payBySmartChain(){try{const t=wt.find(c=>c.chainId===this.file.decryptionguides[0].chainid);await _t(t);const i=q({duration:0,forbidClick:!0,message:"paying"}),a=this.file.fileid,o=await St(),{author:e}=this.readme,n=await M(this.file.decryptionguides[0].contract,this.file.decryptionguides[0].chainid,this.file.fileid),r=await(await o.sendTransaction({to:e,value:n,data:a})).wait();await J(u.account,this.file.decryptionguides[0].chainid,this.$route.params.cid,"SMART_CHAIN",e,n,new Date().getTime(),r.transactionHash,this.readme.introduction),i.message="pay success",await new Promise((c,d)=>setTimeout(()=>{c(0)},1e3)),i.message="Waiting confirm",await new Promise((c,d)=>setTimeout(()=>{c(0)},50*1e3)),i.message="downloading",await this.downloadBySmartChain(),B()}catch(t){B(),T(t.message)}},async download(t){const i=this.$route.params.cid,a=await x.getConfig(i),o=a.files[0];this.url=await x.getDownloadUrl(i,o.filename,a,[t])},async downloadBySTOCHASTIC(){const t=await X.payments.where({account:u.account,cid:this.$route.params.cid,type:"STOCHASTIC"}).last();await this.download(t.calldata)},async downloadBySmartChain(){const t=this.$route.params.cid,a=(await x.getConfig(t)).files[0],o=a.fileid,e=await X.payments.get({account:u.account,cid:this.$route.params.cid}),{txId:n}=e,s=await new k.Authorizer(`https://${a.decryptionguides[0].authorizerlist[0]}`).getTx(n,30),r=`0x${k.base64ToHex(s.proof)}`,c=await xt(this.file.decryptionguides[0].chainid,n,r),d=N(o,1,c);await this.download(d)},async check(){try{await Ct(u.account,this.$route.params.cid,Date.now(),this.readme.introduction);const t=this.file,{author:i}=this.readme,a=t.fileid;let o;if(u.account===i)o=N(a,0,"0x"),this.download(o);else{const{price:e,stochasticEnabled:n}=D(a);if(e==="0")await K(t.decryptionguides[0].contract,t.decryptionguides[0].chainid,u.account,D(a).seriesId)&&(o=N(a,0,"0x"),this.download(o));else if(await K(t.decryptionguides[0].contract,t.decryptionguides[0].chainid,u.account,D(a).seriesId)){const r=await X.payments.where({account:u.account,cid:this.$route.params.cid}).last();if(!r){this.payType=n?2:1;return}if(r.type==="MAIN_CHAIN")await this.downloadByMainChain();else if(r.type==="SMART_CHAIN")await this.downloadBySmartChain();else{if(new Date().getTime()-r.timestamp>30*60*1e3){this.payType=n?2:1;return}await this.downloadBySTOCHASTIC()}}}}catch(t){T(t.message)}}}},Zt={style:{margin:"20px"}},Qt={key:0},Kt={key:1,style:{"word-wrap":"break-word"}},te={key:2};function ee(t,i,a,o,e,n){const s=I("van-nav-bar"),r=I("Media"),c=I("van-tab"),d=I("van-button"),p=I("Scores"),y=I("van-tabs"),w=I("van-popup"),g=bt("responsive-popup");return l(),G(w,{show:!0,position:"left",style:{width:"100%",height:"100%"}},{default:P(()=>[At((l(),h("div",null,[U(s,{title:e.file?.filename,"left-text":"Back","left-arrow":"",onClickLeft:i[0]||(i[0]=m=>n.nav())},null,8,["title"]),U(r,{url:e.url},null,8,["url"]),U(y,{"lazy-render":!1},{default:P(()=>[U(c,{title:"introduction"},{default:P(()=>[A("div",Zt,[e.readme?(l(),h("div",Qt,"intro: "+f(e.readme?.introduction),1)):_("",!0),e.readme?(l(),h("div",Kt," author: "+f(e.readme?.author),1)):_("",!0),e.homepage?(l(),h("div",te,"homepage: "+f(e.homepage),1)):_("",!0)])]),_:1}),U(c,{title:"scores"},{default:P(()=>[A("div",null,[!e.url&&e.payType===1?(l(),G(d,{key:0,style:{"margin-left":"30px"},type:"primary",onClick:n.pay},{default:P(()=>[O("Pay")]),_:1},8,["onClick"])):_("",!0)]),A("div",null,[e.store.chainId===1e4&&!e.url&&e.payType===2?(l(),G(d,{key:0,style:{"margin-left":"30px"},type:"primary",onClick:n.payByStochastic},{default:P(()=>[O("StochasticPay")]),_:1},8,["onClick"])):_("",!0)]),U(p,{file:e.file},null,8,["file"])]),_:1})]),_:1})])),[[g]])]),_:1})}const ce=tt(Yt,[["render",ee]]);export{ce as default};
