import{f as oe,p as F,a as ce,b as ue,B as de}from"./empty-3bc3eff6.js";import{b as ne,g as re,e as q,a as H,c as fe,p as pe,d as he}from"./price-a34b76bc.js";import{g as Z,s as C,C as ie,a as N,_ as Y,r as b,b as J,o as v,c as A,w as m,d as M,e as T,f as d,F as D,h as X,i as L,j as E,k as P,t as ae,l as $,m as me,n as ee,p as Q,q as V,u as ye,v as ge,x as ve,W as se,y as te,A as be,z as ke,B as _e}from"./index-b9487ae2.js";import{i as we}from"./db-43d10708.js";function Se(t){return F(t)}const Ce={data(){return{form:{homepage:"",bchPayee:"",seriesPaymentPeriod:"",holdings:[],payments:[],seriesInfos:[],filePriceScaling:""}}},mounted(){this.addHolding(),this.addPayment()},methods:{addHolding(t="",e=""){this.form.holdings.length,this.form.holdings.push({key:this.form.holdings.length,holdingToken:t,holdingScoreCoefficient:e})},removeHolding(t){const e=this.form.holdings.indexOf(t);e!==-1&&this.form.holdings.splice(e,1)},addPayment(t="",e=""){this.form.payments.push({key:this.form.payments.length,paymentToken:t,paymentScoreCoefficient:e})},removePayment(t){const e=this.form.payments.indexOf(t);e!==-1&&this.form.payments.splice(e,1)},async showTokenName(t){console.log("showTokenName:",t);const e=this.form.holdings[t].holdingToken;console.log("tokenAddr:",e);try{const c=await Z(e,C.chainId);console.log("tokenName:",c),this.form.holdings[t].name=c}catch(c){console.log(c)}},async onSubmit(){try{const t=this.form.bchPayee,e=this.form.homepage,c=this.form.holdings.map(a=>a.holdingToken),g=this.form.holdings.map(a=>Se(a.holdingScoreCoefficient)),n=0,r=[],f=[];console.log("_homepage:",e),console.log("_bchAddr:",t),console.log("_seriesPaymentPeriod:",n),console.log("_holdingTokens:",c),console.log("_holdingScoreCoefficients:",g),console.log("_paymentTokens:",r),console.log("_paymentScoreCoefficients:",f);const o=ne(t);console.log("bchEvmAddr:",o);const s=await re(C.chainId,!0);console.log("factory:",s);const u=await(await q.Sesstion.startSession(ie.coordinatorUrl)).coordinator.getProxy("bchrelayer"),h=await fetch(`${u}/evm-address`).then(a=>a.json()).then(a=>a.result),y=await s.create(oe(e),o,h,n,c,g,r,f);console.log("tx:",y),await y.wait()}catch(t){console.log("failed to create proxy:",t),N(t.message)}}}},xe={style:{"text-align":"center"}},Te=E("br",null,null,-1);function Pe(t,e,c,g,n,r){const f=b("van-nav-bar"),o=b("van-field"),s=b("van-cell-group"),p=b("van-icon"),u=b("van-button"),h=b("van-popup"),y=J("responsive-popup");return v(),A(h,{show:!0,position:"left",style:{width:"100%",height:"100%"}},{default:m(()=>[M((v(),T("div",null,[d(f,{title:"Create Contract","left-text":"Back","left-arrow":"",onClickLeft:e[0]||(e[0]=a=>t.$emit("back"))}),d(s,{inset:"",title:"Basic Information"},{default:m(()=>[d(o,{modelValue:n.form.homepage,"onUpdate:modelValue":e[1]||(e[1]=a=>n.form.homepage=a),center:"",clearable:"",label:"Homepage",placeholder:"Your homepage's URL"},null,8,["modelValue"]),d(o,{modelValue:n.form.bchPayee,"onUpdate:modelValue":e[2]||(e[2]=a=>n.form.bchPayee=a),center:"",clearable:"",label:"CashAddr",placeholder:"Address for receiving BCH"},null,8,["modelValue"])]),_:1}),d(s,{inset:"",title:"Token Score Settings:"},{default:m(()=>[(v(!0),T(D,null,X(n.form.holdings,(a,k)=>(v(),A(s,{inset:"",key:a.key},{default:m(()=>[d(o,{modelValue:a.holdingToken,"onUpdate:modelValue":_=>a.holdingToken=_,center:"",clearable:"",label:a.name||"Token #"+(k+1),placeholder:"Token",onChange:_=>r.showTokenName(k)},null,8,["modelValue","onUpdate:modelValue","label","onChange"]),d(o,{modelValue:a.holdingScoreCoefficient,"onUpdate:modelValue":_=>a.holdingScoreCoefficient=_,center:"",clearable:"",placeholder:"Score",label:"Score"},{button:m(()=>[d(u,{size:"small",onClick:L(_=>r.removeHolding(a),["prevent"]),round:"",type:"primary"},{default:m(()=>[d(p,{name:"delete",size:"18"})]),_:2},1032,["onClick"])]),_:2},1032,["modelValue","onUpdate:modelValue"])]),_:2},1024))),128)),E("p",xe,[d(u,{size:"small",onClick:e[3]||(e[3]=L(a=>r.addHolding(),["prevent"])),round:"",type:"primary"},{default:m(()=>[d(p,{name:"plus"})]),_:1})])]),_:1}),Te,d(u,{type:"primary",style:{float:"right",margin:"10px"},plain:"",onClick:e[4]||(e[4]=a=>r.onSubmit())},{default:m(()=>[P("Create Contract")]),_:1})])),[[y]])]),_:1})}const Ae=Y(Ce,[["render",Pe]]);function G(t){return typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?G=function(e){return typeof e}:G=function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},G(t)}var Ee=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function ze(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}function Ve(t,e){return e={exports:{}},t(e,e.exports),e.exports}var le=Ve(function(t,e){/*!
 * clipboard.js v2.0.6
 * https://clipboardjs.com/
 * 
 * Licensed MIT Â© Zeno Rocha
 */(function(c,g){t.exports=g()})(Ee,function(){return n={},c.m=g=[function(r,f){r.exports=function(o){var s;if(o.nodeName==="SELECT")o.focus(),s=o.value;else if(o.nodeName==="INPUT"||o.nodeName==="TEXTAREA"){var p=o.hasAttribute("readonly");p||o.setAttribute("readonly",""),o.select(),o.setSelectionRange(0,o.value.length),p||o.removeAttribute("readonly"),s=o.value}else{o.hasAttribute("contenteditable")&&o.focus();var u=window.getSelection(),h=document.createRange();h.selectNodeContents(o),u.removeAllRanges(),u.addRange(h),s=u.toString()}return s}},function(r,f){function o(){}o.prototype={on:function(s,p,u){var h=this.e||(this.e={});return(h[s]||(h[s]=[])).push({fn:p,ctx:u}),this},once:function(s,p,u){var h=this;function y(){h.off(s,y),p.apply(u,arguments)}return y._=p,this.on(s,y,u)},emit:function(s){for(var p=[].slice.call(arguments,1),u=((this.e||(this.e={}))[s]||[]).slice(),h=0,y=u.length;h<y;h++)u[h].fn.apply(u[h].ctx,p);return this},off:function(s,p){var u=this.e||(this.e={}),h=u[s],y=[];if(h&&p)for(var a=0,k=h.length;a<k;a++)h[a].fn!==p&&h[a].fn._!==p&&y.push(h[a]);return y.length?u[s]=y:delete u[s],this}},r.exports=o,r.exports.TinyEmitter=o},function(r,f,o){var s=o(3),p=o(4);r.exports=function(u,h,y){if(!u&&!h&&!y)throw new Error("Missing required arguments");if(!s.string(h))throw new TypeError("Second argument must be a String");if(!s.fn(y))throw new TypeError("Third argument must be a Function");if(s.node(u))return z=h,j=y,(R=u).addEventListener(z,j),{destroy:function(){R.removeEventListener(z,j)}};if(s.nodeList(u))return B=u,I=h,x=y,Array.prototype.forEach.call(B,function(U){U.addEventListener(I,x)}),{destroy:function(){Array.prototype.forEach.call(B,function(U){U.removeEventListener(I,x)})}};if(s.string(u))return a=u,k=h,_=y,p(document.body,a,k,_);throw new TypeError("First argument must be a String, HTMLElement, HTMLCollection, or NodeList");var a,k,_,B,I,x,R,z,j}},function(r,f){f.node=function(o){return o!==void 0&&o instanceof HTMLElement&&o.nodeType===1},f.nodeList=function(o){var s=Object.prototype.toString.call(o);return o!==void 0&&(s==="[object NodeList]"||s==="[object HTMLCollection]")&&"length"in o&&(o.length===0||f.node(o[0]))},f.string=function(o){return typeof o=="string"||o instanceof String},f.fn=function(o){return Object.prototype.toString.call(o)==="[object Function]"}},function(r,f,o){var s=o(5);function p(u,h,y,a,k){var _=function(B,I,x,R){return function(z){z.delegateTarget=s(z.target,I),z.delegateTarget&&R.call(B,z)}}.apply(this,arguments);return u.addEventListener(y,_,k),{destroy:function(){u.removeEventListener(y,_,k)}}}r.exports=function(u,h,y,a,k){return typeof u.addEventListener=="function"?p.apply(null,arguments):typeof y=="function"?p.bind(null,document).apply(null,arguments):(typeof u=="string"&&(u=document.querySelectorAll(u)),Array.prototype.map.call(u,function(_){return p(_,h,y,a,k)}))}},function(r,f){if(typeof Element<"u"&&!Element.prototype.matches){var o=Element.prototype;o.matches=o.matchesSelector||o.mozMatchesSelector||o.msMatchesSelector||o.oMatchesSelector||o.webkitMatchesSelector}r.exports=function(s,p){for(;s&&s.nodeType!==9;){if(typeof s.matches=="function"&&s.matches(p))return s;s=s.parentNode}}},function(r,f,o){o.r(f);var s=o(0),p=o.n(s),u=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(i){return typeof i}:function(i){return i&&typeof Symbol=="function"&&i.constructor===Symbol&&i!==Symbol.prototype?"symbol":typeof i};function h(i,l){for(var w=0;w<l.length;w++){var S=l[w];S.enumerable=S.enumerable||!1,S.configurable=!0,"value"in S&&(S.writable=!0),Object.defineProperty(i,S.key,S)}}function y(i){(function(l,w){if(!(l instanceof w))throw new TypeError("Cannot call a class as a function")})(this,y),this.resolveOptions(i),this.initSelection()}var a=(function(i,l,w){return l&&h(i.prototype,l),w&&h(i,w),i}(y,[{key:"resolveOptions",value:function(i){var l=0<arguments.length&&i!==void 0?i:{};this.action=l.action,this.container=l.container,this.emitter=l.emitter,this.target=l.target,this.text=l.text,this.trigger=l.trigger,this.selectedText=""}},{key:"initSelection",value:function(){this.text?this.selectFake():this.target&&this.selectTarget()}},{key:"selectFake",value:function(){var i=this,l=document.documentElement.getAttribute("dir")=="rtl";this.removeFake(),this.fakeHandlerCallback=function(){return i.removeFake()},this.fakeHandler=this.container.addEventListener("click",this.fakeHandlerCallback)||!0,this.fakeElem=document.createElement("textarea"),this.fakeElem.style.fontSize="12pt",this.fakeElem.style.border="0",this.fakeElem.style.padding="0",this.fakeElem.style.margin="0",this.fakeElem.style.position="absolute",this.fakeElem.style[l?"right":"left"]="-9999px";var w=window.pageYOffset||document.documentElement.scrollTop;this.fakeElem.style.top=w+"px",this.fakeElem.setAttribute("readonly",""),this.fakeElem.value=this.text,this.container.appendChild(this.fakeElem),this.selectedText=p()(this.fakeElem),this.copyText()}},{key:"removeFake",value:function(){this.fakeHandler&&(this.container.removeEventListener("click",this.fakeHandlerCallback),this.fakeHandler=null,this.fakeHandlerCallback=null),this.fakeElem&&(this.container.removeChild(this.fakeElem),this.fakeElem=null)}},{key:"selectTarget",value:function(){this.selectedText=p()(this.target),this.copyText()}},{key:"copyText",value:function(){var i=void 0;try{i=document.execCommand(this.action)}catch{i=!1}this.handleResult(i)}},{key:"handleResult",value:function(i){this.emitter.emit(i?"success":"error",{action:this.action,text:this.selectedText,trigger:this.trigger,clearSelection:this.clearSelection.bind(this)})}},{key:"clearSelection",value:function(){this.trigger&&this.trigger.focus(),document.activeElement.blur(),window.getSelection().removeAllRanges()}},{key:"destroy",value:function(){this.removeFake()}},{key:"action",set:function(i){var l=0<arguments.length&&i!==void 0?i:"copy";if(this._action=l,this._action!=="copy"&&this._action!=="cut")throw new Error('Invalid "action" value, use either "copy" or "cut"')},get:function(){return this._action}},{key:"target",set:function(i){if(i!==void 0){if(!i||(i===void 0?"undefined":u(i))!=="object"||i.nodeType!==1)throw new Error('Invalid "target" value, use a valid Element');if(this.action==="copy"&&i.hasAttribute("disabled"))throw new Error('Invalid "target" attribute. Please use "readonly" instead of "disabled" attribute');if(this.action==="cut"&&(i.hasAttribute("readonly")||i.hasAttribute("disabled")))throw new Error(`Invalid "target" attribute. You can't cut text from elements with "readonly" or "disabled" attributes`);this._target=i}},get:function(){return this._target}}]),y),k=o(1),_=o.n(k),B=o(2),I=o.n(B),x=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(i){return typeof i}:function(i){return i&&typeof Symbol=="function"&&i.constructor===Symbol&&i!==Symbol.prototype?"symbol":typeof i},R=function(i,l,w){return l&&z(i.prototype,l),w&&z(i,w),i};function z(i,l){for(var w=0;w<l.length;w++){var S=l[w];S.enumerable=S.enumerable||!1,S.configurable=!0,"value"in S&&(S.writable=!0),Object.defineProperty(i,S.key,S)}}var j=(function(i,l){if(typeof l!="function"&&l!==null)throw new TypeError("Super expression must either be null or a function, not "+typeof l);i.prototype=Object.create(l&&l.prototype,{constructor:{value:i,enumerable:!1,writable:!0,configurable:!0}}),l&&(Object.setPrototypeOf?Object.setPrototypeOf(i,l):i.__proto__=l)}(U,_.a),R(U,[{key:"resolveOptions",value:function(i){var l=0<arguments.length&&i!==void 0?i:{};this.action=typeof l.action=="function"?l.action:this.defaultAction,this.target=typeof l.target=="function"?l.target:this.defaultTarget,this.text=typeof l.text=="function"?l.text:this.defaultText,this.container=x(l.container)==="object"?l.container:document.body}},{key:"listenClick",value:function(i){var l=this;this.listener=I()(i,"click",function(w){return l.onClick(w)})}},{key:"onClick",value:function(i){var l=i.delegateTarget||i.currentTarget;this.clipboardAction&&(this.clipboardAction=null),this.clipboardAction=new a({action:this.action(l),target:this.target(l),text:this.text(l),container:this.container,trigger:l,emitter:this})}},{key:"defaultAction",value:function(i){return W("action",i)}},{key:"defaultTarget",value:function(i){var l=W("target",i);if(l)return document.querySelector(l)}},{key:"defaultText",value:function(i){return W("text",i)}},{key:"destroy",value:function(){this.listener.destroy(),this.clipboardAction&&(this.clipboardAction.destroy(),this.clipboardAction=null)}}],[{key:"isSupported",value:function(i){var l=0<arguments.length&&i!==void 0?i:["copy","cut"],w=typeof l=="string"?[l]:l,S=!!document.queryCommandSupported;return w.forEach(function(O){S=S&&!!document.queryCommandSupported(O)}),S}}]),U);function U(i,l){(function(S,O){if(!(S instanceof O))throw new TypeError("Cannot call a class as a function")})(this,U);var w=function(S,O){if(!S)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!O||typeof O!="object"&&typeof O!="function"?S:O}(this,(U.__proto__||Object.getPrototypeOf(U)).call(this));return w.resolveOptions(l),w.listenClick(i),w}function W(i,l){var w="data-clipboard-"+i;if(l.hasAttribute(w))return l.getAttribute(w)}f.default=j}],c.c=n,c.d=function(r,f,o){c.o(r,f)||Object.defineProperty(r,f,{enumerable:!0,get:o})},c.r=function(r){typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(r,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(r,"__esModule",{value:!0})},c.t=function(r,f){if(1&f&&(r=c(r)),8&f||4&f&&typeof r=="object"&&r&&r.__esModule)return r;var o=Object.create(null);if(c.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:r}),2&f&&typeof r!="string")for(var s in r)c.d(o,s,function(p){return r[p]}.bind(null,s));return o},c.n=function(r){var f=r&&r.__esModule?function(){return r.default}:function(){return r};return c.d(f,"a",f),f},c.o=function(r,f){return Object.prototype.hasOwnProperty.call(r,f)},c.p="",c(c.s=6).default;function c(r){if(n[r])return n[r].exports;var f=n[r]={i:r,l:!1,exports:{}};return g[r].call(f.exports,f,f.exports,c),f.l=!0,f.exports}var g,n})}),Ie=ze(le);le.ClipboardJS;function Ue(t,e,c){var g=document.createElement("button"),n=new Ie(g,{text:function(){return t},action:function(){return"copy"},container:G(e)==="object"?e:document.body});n.on("success",function(r){n.destroy(),c(void 0,r)}),n.on("error",function(r){n.destroy(),c(r,void 0)}),document.body.appendChild(g),g.click(),document.body.removeChild(g)}const He={props:["authorizerAddr"],data(){return{form:{fileValue:[],price:"",series:{value:-1,text:""},introduction:"",stochasticEnabled:!1},showPicker:!1,seriesInfos:[],bchUSDPrice:"0",cid:"",progress:-1,currentRate:0,store:C}},async mounted(){try{const t=await H(this.authorizerAddr,C.chainId,!1),e=(await t.getSeriesLength()).toNumber(),c=await Promise.all(new Array(e).fill(0).map((g,n)=>t.getSeriesInfo(n)));this.seriesInfos=c.map((g,n)=>({...g,value:n,text:ae(g.description)})),this.bchUSDPrice=await fe(C.chainId)}catch(t){console.error(t),N(t.message)}},methods:{onConfirm({selectedOptions:t}){this.form.series.value=t[0].value,this.form.series.text=t[0].text,this.showPicker=!1},copy(t){console.log(t),Ue(`${window.location.origin}/${this.cid}`,void 0,(e,c)=>{e?alert("Can not copy"):ee("copy success")})},async onSubmit(t){try{if(this.form.price&&F(this.form.price).lte(F("0.00001")))return $("Price must greater than 0.00001");if(this.form.price&&F(this.form.price).gt(F("4")))return $("Price must below 4");const e=this.form.fileValue[0].file,c=await q.Sesstion.startSession(ie.coordinatorUrl),g=await q.calcFileHash(e),n=pe(g,F(this.form.price||"0").toString(),this.form.series.value,this.form.stochasticEnabled);e.fileId=n;const r=ce(["uint"],[n]),f=(await H(this.authorizerAddr,C.chainId,!1)).interface.functions["authorize(address,uint256,uint8,bytes)"].format(),o=C.chainId===1e4?"smartbch":"bsc",s=new q.Authorizer(await c.coordinator.getProxy(o)).getUrl(),p={outdata:r,contract:this.authorizerAddr,function_:f,threshold:1,chainId:C.chainId,authorizerlist:[s]},u=await me();this.cid=await c.upload([e],p,JSON.stringify({author:u,introduction:this.form.introduction}),h=>this.progress=h),this.progress=-1,ee("upload success"),await we(u,this.cid,Date.now(),this.form.introduction)}catch(e){this.progress=-1,N(e.message)}}}},Be={style:{margin:"16px 60px"}},Ne={style:{"text-align":"center","margin-top":"20px"}};function Oe(t,e,c,g,n,r){const f=b("van-nav-bar"),o=b("van-uploader"),s=b("van-field"),p=b("van-picker"),u=b("van-popup"),h=b("van-cell-group"),y=b("van-checkbox"),a=b("van-button"),k=b("van-form"),_=b("van-circle"),B=b("van-dialog"),I=J("responsive-popup");return v(),A(u,{show:!0,position:"left",style:{width:"100%",height:"100%"}},{default:m(()=>[M((v(),T("div",null,[d(f,{title:"Upload File to IPFS","left-text":"Back","left-arrow":"",onClickLeft:e[0]||(e[0]=x=>t.$emit("back"))}),d(k,{onSubmit:r.onSubmit},{default:m(()=>[d(h,{inset:""},{default:m(()=>[d(s,{rules:[{required:!0,message:"file"}],name:"uploader",label:"File"},{input:m(()=>[d(o,{"max-count":"1",modelValue:n.form.fileValue,"onUpdate:modelValue":e[1]||(e[1]=x=>n.form.fileValue=x),accept:"*"},null,8,["modelValue"])]),_:1}),d(s,{modelValue:n.form.introduction,"onUpdate:modelValue":e[2]||(e[2]=x=>n.form.introduction=x),rows:"3",autosize:"",label:"Introduction",type:"textarea",placeholder:"Introduce this file"},null,8,["modelValue"]),d(s,{rules:[{required:!0,message:"series"}],modelValue:n.form.series.text,"onUpdate:modelValue":e[3]||(e[3]=x=>n.form.series.text=x),"is-link":"",readonly:"",name:"picker",label:"Series",placeholder:"Series",onClick:e[4]||(e[4]=x=>n.showPicker=!0)},null,8,["modelValue"]),d(u,{show:n.showPicker,"onUpdate:show":e[6]||(e[6]=x=>n.showPicker=x),position:"bottom"},{default:m(()=>[M((v(),T("div",null,[d(p,{columns:n.seriesInfos,onConfirm:r.onConfirm,onCancel:e[5]||(e[5]=x=>n.showPicker=!1),"confirm-button-text":"OK","cancel-button-text":"Cancel"},null,8,["columns","onConfirm"])])),[[I]])]),_:1},8,["show"]),d(s,{modelValue:n.form.price,"onUpdate:modelValue":e[7]||(e[7]=x=>n.form.price=x),name:"price",label:"Price",placeholder:"Price",type:"number"},{extra:m(()=>[P(" â "+Q((parseFloat(n.form.price)*1e5||0)*n.bchUSDPrice/1e5)+" USD ",1)]),_:1},8,["modelValue"])]),_:1}),n.store.chainId===1e4?(v(),A(y,{key:0,style:{"margin-left":"26px"},modelValue:n.form.stochasticEnabled,"onUpdate:modelValue":e[8]||(e[8]=x=>n.form.stochasticEnabled=x)},{default:m(()=>[P("Use stochastic payment for one-time view")]),_:1},8,["modelValue"])):V("",!0),E("div",Be,[n.cid?V("",!0):(v(),A(a,{key:0,plain:"",block:"",type:"primary","native-type":"submit"},{default:m(()=>[P(" Upload ")]),_:1})),n.cid?(v(),A(a,{key:1,plain:"",block:"",type:"primary",onClick:r.copy},{default:m(()=>[P(" Copy the link for sharing ")]),_:1},8,["onClick"])):V("",!0)])]),_:1},8,["onSubmit"]),d(B,{show:n.progress!==-1,title:"Uploading...",style:{width:"200px",height:"200px"},"show-confirm-button":!1},{default:m(()=>[E("div",Ne,[d(_,{"current-rate":n.currentRate,"onUpdate:currentRate":e[9]||(e[9]=x=>n.currentRate=x),rate:n.progress,speed:100,text:n.currentRate+"%"},null,8,["current-rate","rate","text"])])]),_:1},8,["show"])])),[[I]])]),_:1})}const Fe=Y(He,[["render",Oe]]);function K(t){return de(t).div(se.toString()).toString()}function Le(t){return se.mul(t)}const Re={props:["authorizerAddr"],data(){return{form:{homepage:"",bchPayee:"",seriesPaymentPeriod:"",bchTxRelayer:"",holdings:[],payments:[],seriesInfos:[],filePriceScaling:""}}},async mounted(){this.init()},methods:{async init(){const t=await H(this.authorizerAddr,C.chainId,!0),{_holdingScoreCoefficients:e,_holdingTokens:c,_paymentScoreCoefficients:g,_paymentTokens:n}=await t.getScoreCoefficients();this.form.holdings=[];for(let o=0;o<c.length;o++)this.addHolding(c[o],K(e[o].toString()));this.form.payments=[];for(let o=0;o<n.length;o++)this.addPayment(n[o],K(g[o].toString()));this.form.seriesPaymentPeriod=(await t.seriesPaymentPeriod()).toString(),this.form.bchPayee=he(await t.bchPayee()),this.form.bchTxRelayer=await t.bchTxRelayer();const r=(await t.getSeriesLength()).toNumber(),f=await Promise.all(new Array(r).fill(0).map((o,s)=>t.getSeriesInfo(s)));this.form.seriesInfos=[],f.forEach(({requiredScore:o,description:s})=>this.addSeriesInfo(K(o.toString()),ae(s))),this.form.homepage=await t.homepage().then(o=>ue(o)),this.form.filePriceScaling=await t.filePriceScaling()},async addHolding(t="",e=""){const c=await Z(t,C.chainId).catch(g=>null);this.form.holdings.push({key:this.form.holdings.length,holdingToken:t,holdingScoreCoefficient:e,name:c})},async showTokenName(t){console.log("showTokenName:",t);const e=this.form.holdings[t].holdingToken;console.log("tokenAddr:",e);try{const c=await Z(e,C.chainId);console.log("tokenName:",c),this.form.holdings[t].name=c}catch(c){this.form.holdings[t].name=null,console.log(c)}},removeHolding(t){const e=this.form.holdings.indexOf(t);e!==-1&&this.form.holdings.splice(e,1)},UpdateHolding(t){},addPayment(t="",e=""){this.form.payments.push({key:this.form.payments.length,paymentToken:t,paymentScoreCoefficient:e})},removePayment(t){const e=this.form.payments.indexOf(t);e!==-1&&this.form.payments.splice(e,1)},updatePayment(t){},addSeriesInfo(t="",e=""){this.form.seriesInfos.push({index:this.form.seriesInfos.length,requiredScore:t,description:e,isNew:!t})},async removeSeriesInfo(t){const e=this.form.seriesInfos.indexOf(t);e!==-1&&this.form.seriesInfos.splice(e,1)},async updateSeriesInfo(t){console.log("updateSeriesInfo ...");try{const e=await H(this.authorizerAddr,C.chainId,!0),c=t.description.replaceAll("\0",""),g=ye(c),n=ge(g),r=ve(n,16),f=Le(t.requiredScore);let o;t.isNew?(console.log("add"),o=await e.addSeries(f,r)):(console.log("update"),o=await e.updateSeries(t.index,f,r)),await o.wait(),await this.init()}catch(e){N(e.message)}},async updateFilePriceScaling(){await(await(await H(this.authorizerAddr,C.chainId,!0)).updateFilePriceScaling(this.form.filePriceScaling)).wait()},async updateHP(){try{console.log("update hp...",this.form.homepage);const t=await H(this.authorizerAddr,C.chainId,!0);console.log("auth:",t);const e=await t.updateHomepage(oe(this.form.homepage));console.log(e)}catch(t){console.log("failed to update HP:",t),N(t.message)}},async updateBchAddr(){try{console.log("update bch addr...",this.form.bchPayee);const t=ne(this.form.bchPayee);console.log("evmAddr:",t);const e=await H(this.authorizerAddr,C.chainId,!0);console.log("auth:",e);const c=await e.updateBchPayee(t);console.log(c)}catch(t){console.log("failed to update bch addr:",t),N(t.message)}},async updateBchTxRelayer(){try{const e=await(await H(this.authorizerAddr,C.chainId,!0)).updateBchTxRelayer(this.form.bchTxRelayer);console.log(e)}catch(t){console.log("failed to update bch addr:",t),N(t.message)}},async updateHoldingScoreCoefficients(){try{console.log("updateHoldingScoreCoefficients...");const t=[],e=[];this.form.holdings.forEach(r=>{t.push(r.holdingToken),e.push(F(r.holdingScoreCoefficient))}),console.log("newHoldingTokens:",t,e);const c=await H(this.authorizerAddr,C.chainId,!0),[g]=await c.getScoreCoefficients();console.log("oldHoldingTokens:",g);for(let r of g)t.indexOf(r)<0&&(t.push(r),e.push(0));console.log("newHoldingTokens:",t,e);const n=await c.updateScoreCoefficients(t,e,[],[]);console.log("tx:",n)}catch(t){console.log("failed to update HoldingScoreCoefficients:",t),N(t.message)}}}},je={style:{"text-align":"center","margin-bottom":"6px"}},Me={style:{"text-align":"right","padding-right":"12px"}},qe={style:{"text-align":"right"}},De={style:{"text-align":"center"}};function Ge(t,e,c,g,n,r){const f=b("van-nav-bar"),o=b("van-button"),s=b("van-field"),p=b("van-cell-group"),u=b("van-icon"),h=b("van-popup"),y=J("responsive-popup");return v(),A(h,{show:!0,position:"left",style:{width:"100%",height:"100%"}},{default:m(()=>[M((v(),T("div",null,[d(f,{title:"Configuration","left-text":"Back","left-arrow":"",onClickLeft:e[0]||(e[0]=a=>t.$emit("back"))}),E("div",null,[d(p,{inset:"",title:"Basic Information"},{default:m(()=>[d(s,{modelValue:n.form.homepage,"onUpdate:modelValue":e[2]||(e[2]=a=>n.form.homepage=a),center:"",clearable:"",label:"Homepage",placeholder:"Your homepage's URL"},{button:m(()=>[d(o,{size:"small",onClick:e[1]||(e[1]=a=>r.updateHP()),plain:"",type:"primary"},{default:m(()=>[P("Update")]),_:1})]),_:1},8,["modelValue"]),d(s,{modelValue:n.form.bchTxRelayer,"onUpdate:modelValue":e[4]||(e[4]=a=>n.form.bchTxRelayer=a),center:"",clearable:"",label:"JudgerAddr",placeholder:"For Stochastic Payment"},{button:m(()=>[d(o,{size:"small",onClick:e[3]||(e[3]=a=>r.updateBchTxRelayer()),plain:"",type:"primary"},{default:m(()=>[P("Update")]),_:1})]),_:1},8,["modelValue"]),d(s,{modelValue:n.form.bchPayee,"onUpdate:modelValue":e[6]||(e[6]=a=>n.form.bchPayee=a),center:"",clearable:"",label:"CashAddr",placeholder:"For receiving BCH"},{button:m(()=>[d(o,{size:"small",onClick:e[5]||(e[5]=a=>r.updateBchAddr()),plain:"",type:"primary"},{default:m(()=>[P("Update")]),_:1})]),_:1},8,["modelValue"]),d(s,{modelValue:n.form.filePriceScaling,"onUpdate:modelValue":e[8]||(e[8]=a=>n.form.filePriceScaling=a),center:"",clearable:"",label:"Price Scaling",placeholder:"Scaling factor for all files"},{button:m(()=>[d(o,{size:"small",onClick:e[7]||(e[7]=a=>r.updateFilePriceScaling()),plain:"",type:"primary"},{default:m(()=>[P("Update")]),_:1})]),_:1},8,["modelValue"])]),_:1}),d(p,{inset:"",title:"Token Score Settings:"},{default:m(()=>[(v(!0),T(D,null,X(n.form.holdings,(a,k)=>(v(),A(p,{inset:"",key:a.key},{default:m(()=>[d(s,{modelValue:a.holdingToken,"onUpdate:modelValue":_=>a.holdingToken=_,center:"",clearable:"",label:a.name||"Token #"+(k+1),onChange:_=>r.showTokenName(k)},null,8,["modelValue","onUpdate:modelValue","label","onChange"]),d(s,{modelValue:a.holdingScoreCoefficient,"onUpdate:modelValue":_=>a.holdingScoreCoefficient=_,center:"",clearable:"",label:"score"},{button:m(()=>[d(o,{size:"small",onClick:L(_=>r.removeHolding(a),["prevent"]),round:"",type:"primary"},{default:m(()=>[d(u,{name:"delete-o",size:"18"})]),_:2},1032,["onClick"])]),_:2},1032,["modelValue","onUpdate:modelValue"])]),_:2},1024))),128))]),_:1}),E("p",je,[d(o,{size:"small",onClick:e[9]||(e[9]=L(a=>r.addHolding(),["prevent"])),round:"",type:"primary"},{default:m(()=>[d(u,{name:"plus"})]),_:1})]),E("p",Me,[d(o,{size:"small",plain:"",type:"primary",onClick:e[10]||(e[10]=L(a=>r.updateHoldingScoreCoefficients(),["prevent"]))},{default:m(()=>[P(" Update Token Score Settings")]),_:1})]),d(p,{inset:"",title:"Series"},{default:m(()=>[(v(!0),T(D,null,X(n.form.seriesInfos,(a,k)=>(v(),T(D,{key:a.key},[d(p,null,{default:m(()=>[d(s,{modelValue:a.description,"onUpdate:modelValue":_=>a.description=_,clearable:"",label:"Series#"+(k+1),placeholder:"Series Name"},null,8,["modelValue","onUpdate:modelValue","label"]),d(s,{modelValue:a.requiredScore,"onUpdate:modelValue":_=>a.requiredScore=_,clearable:"",label:"Score",placeholder:"Required Score"},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024),E("p",qe,[d(o,{size:"small",type:"primary",onClick:L(_=>r.updateSeriesInfo(a),["prevent"]),plain:""},{default:m(()=>[P(Q((a.isNew?"Create":"Update")+" Series #"+(k+1)),1)]),_:2},1032,["onClick"])])],64))),128))]),_:1}),E("p",De,[d(o,{size:"small",onClick:e[11]||(e[11]=L(a=>r.addSeriesInfo(),["prevent"])),round:"",type:"primary"},{default:m(()=>[d(u,{name:"plus"})]),_:1})])])])),[[y]])]),_:1})}const Ye=Y(Re,[["render",Ge]]),Je={components:{CreateContract:Ae,UploadFile:Fe,Configuration:Ye},data(){return{mmInstalled:!1,showPicker:!1,supportedChains:te.map(t=>({text:t.chainName,value:t.chainId})),store:C,authorizerAddr:"-1",showType:"",seriesCount:0}},watch:{"store.account"(t,e){t&&e&&window.location.reload(),this.init()},"store.chainId"(t,e){t&&e&&window.location.reload(),this.init()}},async mounted(){this.init()},methods:{async init(){if(console.log("eth:",window.ethereum),this.mmInstalled=!!window.ethereum,!C.account||!C.chainId)return;console.log("account:",C.account);const t=await(await re(C.chainId,!1)).authorToProxy(C.account);if(console.log("authorizerAddr:",t),t!==be){this.authorizerAddr=t;const c=await(await H(this.authorizerAddr,C.chainId,!1)).getSeriesLength();console.log("seriesCount:",c),this.seriesCount=c.toNumber()}else this.authorizerAddr=""},async onBack(){this.showType="",await this.init()},async connectToChain({selectedOptions:t}){try{this.showPicker=!1;const e=t[0].value;console.log("selectedChainId:",e);const c=te.find(g=>g.chainId===e);await ke(),await _e(c),window.location.reload()}catch(e){console.error(e),N(e.message)}}}},We={style:{padding:"8px"}},Ke={key:0},Ze={key:1},Xe={key:0},Qe={key:1},$e={key:2,style:{"margin-top":"20px"}},et=E("p",null,"You have not created an authorizing contract. Please create one to authorize your audience.",-1),tt={key:3,style:{"margin-top":"20px"}},ot=E("p",null,"The authorizing contract is ready. The uploaded files will use it to authorize audience.",-1),nt={key:4,style:{"margin-top":"20px"}},rt=E("p",null,"You can further configure the authorizing contract to meet your needs.",-1);function it(t,e,c,g,n,r){const f=b("van-field"),o=b("van-picker"),s=b("van-popup"),p=b("van-button"),u=b("CreateContract"),h=b("UploadFile"),y=b("Configuration"),a=J("responsive-popup");return v(),T("div",We,[n.mmInstalled?(v(),T("div",Ze,[![1e4,56].includes(n.store.chainId)||!n.store.account?(v(),T("div",Xe,[P(" ElfinGuard Gateway only supports smartBCH and BSC for deploying authorizing contracts. Please make your wallet connet to one of them: "),d(f,{"is-link":"",readonly:"",label:"Connect To",placeholder:"supported chains",onClick:e[0]||(e[0]=k=>n.showPicker=!0)}),d(s,{show:n.showPicker,"onUpdate:show":e[2]||(e[2]=k=>n.showPicker=k),round:"",position:"bottom"},{default:m(()=>[M((v(),T("div",null,[d(o,{columns:n.supportedChains,onCancel:e[1]||(e[1]=k=>n.showPicker=!1),onConfirm:r.connectToChain,"confirm-button-text":"OK","cancel-button-text":"Cancel"},null,8,["columns","onConfirm"])])),[[a]])]),_:1},8,["show"])])):(v(),T("div",Qe," Connected Chain: "+Q(n.store.chainId==1e4?"smartBCH":"BSC"),1)),n.authorizerAddr!=="-1"&&!n.authorizerAddr?(v(),T("div",$e,[et,d(p,{size:"small",onClick:e[3]||(e[3]=k=>n.showType="CreateContract"),plain:"",type:"primary"},{default:m(()=>[P("Create Authorizing Contract")]),_:1})])):V("",!0),n.authorizerAddr!=="-1"&&n.authorizerAddr?(v(),T("div",tt,[ot,n.authorizerAddr&&n.seriesCount>0?(v(),A(p,{key:0,size:"small",plain:"",type:"primary",onClick:e[4]||(e[4]=k=>n.showType="UploadFile")},{default:m(()=>[P("Upload File to IPFS")]),_:1})):V("",!0)])):V("",!0),n.authorizerAddr!=="-1"&&n.authorizerAddr?(v(),T("div",nt,[rt,n.authorizerAddr?(v(),A(p,{key:0,size:"small",plain:"",type:"primary",onClick:e[5]||(e[5]=k=>n.showType="Configuration")},{default:m(()=>[P("Configure Contract")]),_:1})):V("",!0)])):V("",!0),n.showType==="CreateContract"?(v(),A(u,{key:5,onBack:r.onBack},null,8,["onBack"])):V("",!0),n.showType==="UploadFile"?(v(),A(h,{key:6,authorizerAddr:n.authorizerAddr,onBack:r.onBack},null,8,["authorizerAddr","onBack"])):V("",!0),n.showType==="Configuration"?(v(),A(y,{key:7,authorizerAddr:n.authorizerAddr,onBack:r.onBack},null,8,["authorizerAddr","onBack"])):V("",!0)])):(v(),T("div",Ke," EflinGuard Gateway must work with a Web3 wallet. Please install a wallet plugin such as MetaMask to your browser, or use a mobile wallet App. "))])}const ut=Y(Je,[["render",it]]);export{ut as default};
